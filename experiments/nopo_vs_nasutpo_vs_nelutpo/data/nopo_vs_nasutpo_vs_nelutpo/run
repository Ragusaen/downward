#! /usr/bin/env python

import logging
import os
import multiprocessing
import subprocess
import sys

from lab.experiment import get_run_dir
from lab import tools

tools.configure_logging()

SHUFFLED_TASK_IDS = [797, 523, 736, 348, 568, 622, 747, 1088, 133, 494, 764, 243, 349, 31, 908, 584, 321, 826, 1099, 49, 310, 449, 1031, 964, 534, 1034, 768, 428, 632, 698, 623, 454, 10, 24, 303, 1055, 320, 111, 307, 229, 1053, 1022, 173, 193, 148, 81, 239, 365, 223, 624, 734, 135, 538, 586, 1070, 737, 60, 396, 686, 89, 525, 1021, 192, 943, 1075, 45, 640, 754, 894, 557, 394, 806, 137, 763, 540, 707, 979, 276, 651, 962, 253, 97, 1073, 997, 947, 481, 986, 724, 372, 113, 688, 818, 226, 803, 969, 519, 978, 608, 679, 626, 83, 646, 550, 934, 40, 556, 1015, 499, 884, 384, 401, 935, 422, 1061, 892, 909, 907, 1100, 1082, 470, 282, 863, 279, 33, 1046, 214, 627, 1081, 891, 114, 1098, 388, 597, 298, 893, 661, 53, 796, 744, 1009, 548, 850, 399, 420, 1096, 718, 659, 595, 732, 235, 67, 182, 172, 342, 327, 1016, 338, 183, 765, 782, 872, 98, 614, 398, 78, 658, 684, 341, 188, 391, 317, 332, 848, 191, 187, 699, 1058, 1068, 513, 783, 304, 843, 9, 835, 247, 344, 702, 392, 224, 991, 387, 933, 1005, 832, 569, 716, 146, 963, 987, 752, 804, 774, 128, 967, 689, 1006, 106, 865, 213, 367, 231, 895, 606, 601, 976, 400, 414, 240, 404, 448, 750, 216, 914, 426, 1056, 34, 857, 295, 805, 386, 906, 705, 757, 459, 278, 238, 252, 1072, 565, 72, 693, 13, 433, 156, 92, 405, 46, 101, 248, 974, 157, 1092, 51, 127, 990, 898, 360, 429, 292, 244, 356, 642, 316, 166, 662, 918, 526, 829, 222, 630, 283, 885, 520, 1059, 552, 196, 816, 786, 473, 541, 272, 896, 118, 1078, 1083, 466, 503, 325, 988, 136, 778, 674, 480, 48, 366, 555, 286, 462, 957, 931, 982, 165, 75, 82, 152, 760, 1051, 242, 230, 948, 1036, 824, 257, 1023, 1057, 202, 628, 960, 553, 324, 683, 596, 706, 711, 873, 483, 730, 345, 582, 185, 593, 168, 220, 1049, 667, 571, 363, 264, 1000, 741, 42, 397, 96, 1094, 370, 715, 102, 855, 549, 878, 527, 368, 371, 669, 858, 860, 767, 109, 887, 731, 903, 773, 629, 506, 784, 273, 407, 995, 649, 852, 347, 73, 346, 339, 17, 973, 756, 461, 93, 424, 35, 285, 458, 225, 18, 983, 901, 210, 952, 439, 312, 181, 603, 966, 217, 621, 174, 1065, 423, 329, 883, 510, 477, 652, 357, 544, 451, 270, 945, 890, 751, 1029, 954, 444, 482, 831, 671, 977, 417, 50, 867, 23, 256, 665, 175, 358, 657, 653, 911, 1012, 551, 381, 219, 807, 227, 1043, 221, 821, 436, 876, 620, 781, 727, 532, 162, 925, 521, 961, 476, 164, 762, 12, 1050, 501, 402, 827, 331, 475, 62, 389, 107, 76, 1025, 609, 515, 641, 668, 208, 215, 145, 488, 558, 712, 851, 1014, 681, 110, 254, 218, 322, 739, 1037, 288, 1042, 856, 599, 446, 313, 179, 277, 442, 676, 373, 643, 105, 717, 975, 167, 869, 511, 153, 970, 801, 562, 205, 112, 121, 59, 672, 675, 592, 868, 819, 364, 474, 723, 517, 463, 999, 4, 438, 377, 580, 951, 518, 708, 1069, 69, 759, 351, 280, 362, 971, 579, 902, 361, 115, 1026, 663, 729, 922, 758, 559, 590, 870, 877, 163, 251, 839, 61, 267, 1017, 492, 1047, 1064, 919, 1085, 1040, 787, 178, 169, 1001, 467, 514, 104, 427, 809, 430, 161, 504, 798, 468, 147, 605, 21, 1030, 190, 5, 440, 790, 1071, 55, 670, 725, 337, 314, 882, 1035, 245, 1077, 71, 434, 743, 1004, 610, 143, 415, 79, 418, 837, 41, 1033, 232, 403, 889, 745, 647, 1007, 779, 108, 170, 409, 305, 37, 888, 633, 435, 318, 52, 899, 776, 638, 780, 695, 554, 812, 465, 1095, 464, 308, 785, 301, 497, 447, 197, 996, 879, 830, 639, 460, 1010, 560, 443, 354, 74, 660, 453, 234, 334, 600, 853, 87, 1093, 823, 685, 275, 635, 788, 11, 410, 478, 323, 844, 299, 770, 496, 1091, 697, 212, 333, 570, 789, 490, 374, 928, 912, 250, 841, 1008, 271, 522, 617, 311, 512, 95, 493, 800, 236, 613, 1101, 140, 1074, 1002, 186, 528, 487, 881, 249, 1080, 1018, 3, 287, 38, 14, 263, 6, 241, 30, 199, 817, 1044, 289, 655, 486, 315, 703, 1060, 777, 793, 673, 509, 455, 900, 946, 944, 379, 738, 491, 158, 692, 530, 875, 636, 792, 842, 84, 228, 864, 691, 740, 545, 319, 479, 849, 56, 766, 1041, 687, 343, 29, 260, 7, 160, 1087, 412, 132, 408, 26, 845, 915, 201, 537, 833, 1063, 44, 572, 139, 619, 998, 690, 529, 682, 268, 547, 150, 930, 261, 713, 927, 722, 184, 886, 176, 119, 1066, 457, 680, 20, 968, 616, 612, 820, 1084, 8, 666, 576, 330, 1076, 300, 180, 937, 956, 897, 591, 206, 484, 290, 266, 1039, 862, 16, 615, 28, 721, 131, 772, 425, 123, 678, 631, 516, 103, 813, 607, 116, 284, 502, 294, 198, 1024, 91, 618, 953, 650, 421, 575, 1020, 1067, 500, 994, 1011, 913, 77, 138, 1038, 880, 701, 328, 929, 1090, 836, 154, 932, 350, 47, 677, 125, 742, 834, 588, 539, 726, 791, 258, 564, 825, 644, 795, 471, 959, 68, 567, 536, 100, 450, 1054, 489, 265, 85, 910, 587, 88, 531, 189, 36, 171, 134, 80, 611, 151, 602, 419, 39, 1, 746, 485, 874, 281, 972, 815, 469, 802, 847, 733, 1062, 207, 861, 378, 543, 799, 296, 941, 533, 505, 838, 144, 456, 472, 117, 94, 43, 1032, 704, 432, 1027, 585, 696, 714, 936, 141, 905, 546, 336, 775, 22, 142, 840, 508, 375, 126, 710, 413, 808, 561, 563, 376, 535, 810, 495, 64, 589, 194, 923, 233, 748, 637, 822, 938, 390, 984, 369, 811, 352, 664, 120, 15, 1089, 654, 720, 581, 27, 866, 262, 981, 920, 993, 728, 211, 274, 411, 1003, 871, 237, 452, 577, 604, 441, 195, 761, 66, 359, 921, 2, 1048, 129, 771, 940, 498, 406, 917, 985, 648, 209, 916, 25, 293, 155, 814, 445, 200, 437, 385, 309, 828, 1013, 340, 395, 1079, 904, 149, 846, 326, 578, 992, 302, 1052, 54, 19, 1045, 645, 749, 542, 383, 656, 949, 942, 1019, 32, 382, 416, 634, 939, 431, 159, 63, 246, 130, 735, 380, 926, 753, 854, 924, 297, 989, 255, 566, 58, 90, 1097, 355, 203, 574, 524, 70, 86, 980, 958, 306, 694, 950, 1028, 99, 57, 393, 719, 594, 965, 291, 598, 124, 1086, 709, 625, 573, 955, 755, 204, 794, 177, 859, 353, 122, 507, 769, 65, 269, 335, 700, 583, 259]

# Make sure we're in the experiment directory.
os.chdir(os.path.dirname(os.path.abspath(__file__)))


def get_run_id(task_id):
    return SHUFFLED_TASK_IDS[task_id - 1]


def process_task(task_id):
    run_id = get_run_id(task_id)
    run_dir = get_run_dir(run_id)
    error = False
    with open(os.path.join(run_dir, "driver.log"), "w") as driver_log:
        with open(os.path.join(run_dir, "driver.err"), "w") as driver_err:
            logging.info(f"Starting run {run_id} (TASK_ID {task_id}) in {run_dir}")
            try:
                subprocess.check_call(
                    [tools.get_python_executable(), "run"],
                    cwd=run_dir, stdout=driver_log, stderr=driver_err)
            except subprocess.CalledProcessError as err:
                error = True
    if os.path.getsize(driver_err.name) != 0:
        error = True
    for f in [driver_log, driver_err]:
        if os.path.getsize(f.name) == 0:
            os.remove(f.name)
    return error


def main():
    pool = multiprocessing.Pool(processes=4)
    num_tasks = len(SHUFFLED_TASK_IDS)
    result = pool.map_async(process_task, range(1, num_tasks + 1))
    try:
        # Use "timeout" to fix passing KeyboardInterrupts from children
        # (see https://stackoverflow.com/questions/1408356).
        result.wait(timeout=99999)
    except KeyboardInterrupt:
        logging.warning("Main script interrupted")
        pool.terminate()
    finally:
        pool.close()
        logging.info("Joining pool processes")
        pool.join()

    if any(result.get()):
        sys.exit("Error: At least one run failed.")


if __name__ == "__main__":
    main()
